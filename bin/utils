#!/usr/bin/env bash
shopt -s extglob

[ $(uname) == "Darwin" ] && SED_FLAG='-l' || SED_FLAG='-u'

# Indent output as per Heroku style guide.
indent() {
  RE="s/^/       /"
  sed $SED_FLAG "$RE"
}

# Does some serious copying.
function deep-cp (){
  find -H $1 -maxdepth 1 -name '.*' -a \( -type d -o -type f -o -type l \) -exec cp -a '{}' $2 \;
  cp -r $1/!(tmp) $2
}

# Does some serious moving.
function deep-mv (){
  deep-cp $1 $2

  rm -fr $1/!(tmp)
  find -H $1 -maxdepth 1 -name '.*' -a \( -type d -o -type f -o -type l \) -exec rm -fr '{}' \;
}

# Tweak directories to build the app in the home directory (/app) instead of 
# Heroku's build directory.
# 
# Moves existing content in home to /tmp/home and moves build directory content 
# to the home directory. Use this at the beginning of the build process.
start-build-in-home() {
  echo "Start building in ${HOME}." | indent
  ORIG_BUILD_DIR=${BUILD_DIR}
  # Re-set $BUILD_DIR!
  BUILD_DIR=${HOME}
  mkdir -p /tmp/home
  deep-mv "${HOME}" /tmp/home
  deep-mv "${ORIG_BUILD_DIR}" "${BUILD_DIR}"
  cd "${BUILD_DIR}"
}

# Restore build directory tweaks.
#
# Moves home directory content back to Heroku's build directory (otherwise it
# won't be packaged up) and move /tmp/home back to home directory. Use this 
# at the end of the build process.
finish-build-in-home() {
  echo "Finish building in ${BUILD_DIR}." | indent
  deep-mv "${BUILD_DIR}" "${ORIG_BUILD_DIR}"
  deep-mv /tmp/home "${HOME}"
}
